<?php

/**
 * マップデータ取得API
 * GET /api/get_map.php?id=1
 */

header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, OPTIONS');

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit;
}

$mapId = isset($_GET['id']) ? intval($_GET['id']) : 1;

// マップデータ（データベースの代わりに配列で定義）
$mapData = [
    'map_id' => $mapId,
    'width' => 20,
    'height' => 20,
    'tiles' => [
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 1, 1],
        [1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 1, 1, 1],
        [1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 1, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 1, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
    ],
    'legend' => [
        0 => 'floor',
        1 => 'wall',
        2 => 'water'
    ],
    'encounter_rate' => 0.01,
    'possible_enemies' => ['e001', 'e002', 'e003'],
    'player_assets' => [
        'model_url' => 'assets/fbx/character1_idle.fbx',
        "anim_walk_url" => "assets/fbx/character1_walk.fbx",
        'scale' => 0.01
    ],
    'npcs' => [
        [
            'id' => 'n001',
            'name' => '村人',
            'x' => 4,
            'z' => 4,
            'color' => '#0066ff',
            'scale' => 0.01,
            'model_url' => 'assets/fbx/character4_idle.fbx',
            'dialogues' => [
                'ここは平和な村です。',
                '北の森には気をつけて！'
            ]
        ],
        [
            'id' => 'n002',
            'name' => 'ガード',
            'x' => 10,
            'z' => 8,
            'color' => '#ff6600',
            'scale' => 0.01,
            'model_url' => 'assets/fbx/character5_idle.fbx',
            'dialogues' => [
                'この村は厳重に守られている。',
                'あなたは誰ですか？'
            ]
        ]
    ],
    'events' => [
        [
            'id' => 'ev003',
            'type' => 'heal',
            'x' => 2,
            'z' => 4,
            'message' => 'この場所は聖域。体力が全快した！'
        ]
    ]
];

echo json_encode([
    'status' => 'success',
    'data' => [
        'map' => $mapData
    ]
]);
